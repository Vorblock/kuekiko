<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Vorblock">
<meta name="description" content="第一章 Android中锁屏密码加密算法分析 1. 锁屏密码方式：  手势 九宫格连线 输入密码 指纹、人脸、虹膜 可穿戴设备  2. 这儿分析手势密码和输入密码 找到android源代码中的LockPatternUtils,java 这个工具类
路径：Android-5.1.1\frameworks\base\core\java\com\android\internal\widget
 2.1 输入密码算法分析 (5.1版本的源代码 和书上细微差异)
 public byte[] passwordToHash(String password, int userId) {//参数为密码和对应用户ID 默认0  if (password == null) { return null; } try { byte[] saltedPassword = (password &#43; getSalt(userId)).getBytes(); byte[] sha1 = MessageDigest.getInstance(&amp;#34;SHA-1&amp;#34;).digest(saltedPassword); byte[] md5 = MessageDigest.getInstance(&amp;#34;MD5&amp;#34;).digest(saltedPassword); //首先让 password&#43;salt值 再SHA-1和MD5  byte[] combined = new byte[sha1.length &#43; md5.length]; System.arraycopy(sha1, 0, combined, 0, sha1." />
<meta name="keywords" content=", android安全, 读书笔记" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://kuekiko.top/posts/2018/07/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%87/" />


    <title>
        
            Android应用安全防护和逆向分析 基础篇① :: Kuekiko` blog  — Recorded living tip
        
    </title>




<link href="https://cdn.bootcdn.net/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://kuekiko.top/main.154a87e0ff720e102948892a8eb80881aa81a4faf37376f3093be219f6296c3d.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://kuekiko.top/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://kuekiko.top/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://kuekiko.top/favicon-16x16.png">
    <link rel="manifest" href="https://kuekiko.top/site.webmanifest">
    <link rel="mask-icon" href="https://kuekiko.top/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://kuekiko.top/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



<meta itemprop="name" content="Android应用安全防护和逆向分析 基础篇①">
<meta itemprop="description" content="Android中锁屏密码加密算法分析">
<meta itemprop="datePublished" content="2018-07-02T17:33:05+08:00" />
<meta itemprop="dateModified" content="2018-07-02T17:33:05+08:00" />
<meta itemprop="wordCount" content="647">
<meta itemprop="image" content="https://kuekiko.top"/>



<meta itemprop="keywords" content="android安全,读书笔记," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kuekiko.top"/>

<meta name="twitter:title" content="Android应用安全防护和逆向分析 基础篇①"/>
<meta name="twitter:description" content="Android中锁屏密码加密算法分析"/>



    <meta property="og:title" content="Android应用安全防护和逆向分析 基础篇①" />
<meta property="og:description" content="Android中锁屏密码加密算法分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kuekiko.top/posts/2018/07/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%87/" />
<meta property="og:image" content="https://kuekiko.top"/>
<meta property="article:published_time" content="2018-07-02T17:33:05+08:00" />
<meta property="article:modified_time" content="2018-07-02T17:33:05+08:00" />




    <meta property="article:section" content="读书笔记" />

    <meta property="article:section" content="Android安全" />



    <meta property="article:published_time" content="2018-07-02 17:33:05 &#43;0800 CST" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://kuekiko.top/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text"># cd ~/kuekiko/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://kuekiko.top/posts/">Posts</a></li><li><a href="https://kuekiko.top/reading/">Reading</a></li><li><a href="https://kuekiko.top/todo/">Todo</a></li><li><a href="https://kuekiko.top/about/">About</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>4 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://kuekiko.top/posts/2018/07/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%87/">Android应用安全防护和逆向分析 基础篇①</a>
            </h1>

            

            <div class="post-content">
                <h2 id="第一章-android中锁屏密码加密算法分析">第一章 Android中锁屏密码加密算法分析</h2>
<h4 id="1-锁屏密码方式">1. 锁屏密码方式：</h4>
<ul>
<li>手势</li>
<li>九宫格连线</li>
<li>输入密码</li>
<li>指纹、人脸、虹膜</li>
<li>可穿戴设备</li>
</ul>
<h4 id="2-这儿分析手势密码和输入密码">2. 这儿分析手势密码和输入密码</h4>
<p>找到android源代码中的LockPatternUtils,java 这个工具类<br>
路径：Android-5.1.1\frameworks\base\core\java\com\android\internal\widget</p>
<blockquote>
<p>2.1 输入密码算法分析    (5.1版本的源代码 和书上细微差异)</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">passwordToHash</span><span style="color:#f92672">(</span>String password<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//参数为密码和对应用户ID 默认0
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> saltedPassword <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">+</span> getSalt<span style="color:#f92672">(</span>userId<span style="color:#f92672">)).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">();</span>  
            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> sha1 <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SHA-1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span>saltedPassword<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> md5 <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MD5&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span>saltedPassword<span style="color:#f92672">);</span>
<span style="color:#75715e">//首先让 password+salt值 再SHA-1和MD5
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> combined <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>sha1<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">+</span> md5<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">];</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">arraycopy</span><span style="color:#f92672">(</span>sha1<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> combined<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> sha1<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">arraycopy</span><span style="color:#f92672">(</span>md5<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> combined<span style="color:#f92672">,</span> sha1<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">,</span> md5<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
<span style="color:#75715e">//装换成hex值 再拼接起来
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> hexEncoded <span style="color:#f92672">=</span> HexEncoding<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>combined<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>hexEncoded<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>StandardCharsets<span style="color:#f92672">.</span><span style="color:#a6e22e">UTF_8</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchAlgorithmException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AssertionError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Missing digest algorithm: &#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>如何获取设备对应的salt值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getSalt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> salt <span style="color:#f92672">=</span> getLong<span style="color:#f92672">(</span>LOCK_PASSWORD_SALT_KEY<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>salt <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>   <span style="color:#75715e">//值为0  重新生成
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                salt <span style="color:#f92672">=</span> SecureRandom<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SHA1PRNG&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">nextLong</span><span style="color:#f92672">();</span>
                setLong<span style="color:#f92672">(</span>LOCK_PASSWORD_SALT_KEY<span style="color:#f92672">,</span> salt<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>  <span style="color:#75715e">//保存值
</span><span style="color:#75715e"></span>                Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Initialized lock password salt for user: &#34;</span> <span style="color:#f92672">+</span> userId<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchAlgorithmException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Couldn&#39;t get SecureRandom number&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">toHexString</span><span style="color:#f92672">(</span>salt<span style="color:#f92672">);</span>       <span style="color:#75715e">//  hex之后返回
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</code></pre></div><p>继续跟踪 看保存的地方</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLong</span><span style="color:#f92672">(</span>String secureSettingKey<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> defaultValue<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> userHandle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> getLockSettings<span style="color:#f92672">().</span><span style="color:#a6e22e">getLong</span><span style="color:#f92672">(</span>secureSettingKey<span style="color:#f92672">,</span> defaultValue<span style="color:#f92672">,</span> userHandle<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException re<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> defaultValue<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>继续跟踪代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@VisibleForTesting</span>
    <span style="color:#66d9ef">public</span> ILockSettings <span style="color:#a6e22e">getLockSettings</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLockSettingsService <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ILockSettings service <span style="color:#f92672">=</span> ILockSettings<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span><span style="color:#f92672">.</span><span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>
                    ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lock_settings&#34;</span><span style="color:#f92672">));</span>   <span style="color:#75715e">//获取服务来操作
</span><span style="color:#75715e"></span>            mLockSettingsService <span style="color:#f92672">=</span> service<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> mLockSettingsService<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>在android中 这种获取服务的方式最终实现逻辑都是在XXXService类中</p>
<p>这里在LockSettingService.java中  找到这个类的getLong方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLong</span><span style="color:#f92672">(</span>String key<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> defaultValue<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        checkReadPermission<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
        String value <span style="color:#f92672">=</span> getStringUnchecked<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> TextUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>value<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> defaultValue <span style="color:#f92672">:</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">parseLong</span><span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>保存在数据库？</p>
<p>继续跟踪</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Injector</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">protected</span> Context mContext<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Injector</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mContext <span style="color:#f92672">=</span> context<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> Context <span style="color:#a6e22e">getContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> mContext<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> Handler <span style="color:#a6e22e">getHandler</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Handler<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> LockSettingsStorage <span style="color:#a6e22e">getStorage</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> LockSettingsStorage storage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LockSettingsStorage<span style="color:#f92672">(</span>mContext<span style="color:#f92672">);</span>
            storage<span style="color:#f92672">.</span><span style="color:#a6e22e">setDatabaseOnCreateCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LockSettingsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">(</span>SQLiteDatabase db<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Get the lockscreen default from a system property, if available
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">boolean</span> lockScreenDisable <span style="color:#f92672">=</span> SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getBoolean</span><span style="color:#f92672">(</span>
                            <span style="color:#e6db74">&#34;ro.lockscreen.disable.default&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lockScreenDisable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        storage<span style="color:#f92672">.</span><span style="color:#a6e22e">writeKeyValue</span><span style="color:#f92672">(</span>db<span style="color:#f92672">,</span> LockPatternUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">DISABLE_LOCKSCREEN_KEY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">});</span>
            <span style="color:#66d9ef">return</span> storage<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LockSettingsService</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Injector<span style="color:#f92672">(</span>context<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>


</code></pre></div><p>继续  查看LockSettingsStorage.java 类中   存在数据库中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DatabaseHelper</span> <span style="color:#66d9ef">extends</span> SQLiteOpenHelper <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String TAG <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LockSettingsDB&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String DATABASE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;locksettings.db&#34;</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DATABASE_VERSION <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> IDLE_CONNECTION_TIMEOUT_MS <span style="color:#f92672">=</span> 30000<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">private</span> Callback mCallback<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DatabaseHelper</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> DATABASE_NAME<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> DATABASE_VERSION<span style="color:#f92672">);</span>
            setWriteAheadLoggingEnabled<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// Memory optimization - close idle connections after 30s of inactivity
</span><span style="color:#75715e"></span>            setIdleConnectionTimeout<span style="color:#f92672">(</span>IDLE_CONNECTION_TIMEOUT_MS<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span>Callback callback<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mCallback <span style="color:#f92672">=</span> callback<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createTable</span><span style="color:#f92672">(</span>SQLiteDatabase db<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            db<span style="color:#f92672">.</span><span style="color:#a6e22e">execSQL</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CREATE TABLE &#34;</span> <span style="color:#f92672">+</span> TABLE <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (&#34;</span> <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;_id INTEGER PRIMARY KEY AUTOINCREMENT,&#34;</span> <span style="color:#f92672">+</span>
                    COLUMN_KEY <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; TEXT,&#34;</span> <span style="color:#f92672">+</span>
                    COLUMN_USERID <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; INTEGER,&#34;</span> <span style="color:#f92672">+</span>
                    COLUMN_VALUE <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; TEXT&#34;</span> <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;);&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onCreate</span><span style="color:#f92672">(</span>SQLiteDatabase db<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            createTable<span style="color:#f92672">(</span>db<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCallback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mCallback<span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">(</span>db<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onUpgrade</span><span style="color:#f92672">(</span>SQLiteDatabase db<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> oldVersion<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> currentVersion<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> upgradeVersion <span style="color:#f92672">=</span> oldVersion<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>upgradeVersion <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Previously migrated lock screen widget settings. Now defunct.
</span><span style="color:#75715e"></span>                upgradeVersion <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>upgradeVersion <span style="color:#f92672">!=</span> DATABASE_VERSION<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failed to upgrade database!&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>看到了数据库的名字叫作：locksettings.db  保存在了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYSTEM_DIRECTORY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/system/&#34;</span><span style="color:#f92672">;</span>    <span style="color:#75715e">//目录
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOCK_PATTERN_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gatekeeper.pattern.key&#34;</span><span style="color:#f92672">;</span>   
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String BASE_ZERO_LOCK_PATTERN_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gatekeeper.gesture.key&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LEGACY_LOCK_PATTERN_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gesture.key&#34;</span><span style="color:#f92672">;</span>    <span style="color:#75715e">//key1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOCK_PASSWORD_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gatekeeper.password.key&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LEGACY_LOCK_PASSWORD_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;password.key&#34;</span><span style="color:#f92672">;</span>    <span style="color:#75715e">//key2
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String CHILD_PROFILE_LOCK_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gatekeeper.profile.key&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYNTHETIC_PASSWORD_DIRECTORY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spblob/&#34;</span><span style="color:#f92672">;</span>
</code></pre></div><p>数据库文件存在/data/system/locksetting.db</p>
<p>测试  在/data/system/下看到password.key</p>
<p><img src="http://my-md-1253484710.coscd.myqcloud.com/android-note-1-1.png" alt=""></p>
<p>打开看看：<img src="http://my-md-1253484710.coscd.myqcloud.com/android-note-1-2.png" alt=""></p>
<p>手动简单实现加密算法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">passwordToHash</span><span style="color:#f92672">(</span>String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">byte</span> <span style="color:#f92672">[]</span> hashed <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> saltedPassword <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">+</span> SALT<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">();</span>    <span style="color:#75715e">//SALT 值从数据库中得到 拿到之后进行hex转换
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> sha1 <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SHA-1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span>saltedPassword<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> md5 <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MD5&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span>saltedPassword<span style="color:#f92672">);</span>
            hashed <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>toHex<span style="color:#f92672">(</span>sha1<span style="color:#f92672">)+</span>toHex<span style="color:#f92672">(</span>md5<span style="color:#f92672">)).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){</span>
            
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> hashed<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">toHex</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> ary<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">final</span> String hex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;102031398sjdfklaj&#34;</span><span style="color:#f92672">;</span>
        String ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>ary<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>i<span style="color:#f92672">++){</span>
            ret <span style="color:#f92672">+=</span> hex<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">((</span>ary<span style="color:#f92672">[</span>i<span style="color:#f92672">]&gt;&gt;</span> 4<span style="color:#f92672">)&amp;</span> 0xf<span style="color:#f92672">);</span>
            ret <span style="color:#f92672">+=</span> hex<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>ary<span style="color:#f92672">[</span>i<span style="color:#f92672">]&amp;</span> 0xf<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> ret<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>SALT 的值可以从数据库中拿到 也可以利用反射获取</p>
<p>总结：</p>
<p>​	MD5(输的明文密码+设备的salt).hex+ SHA1(输的的明文密码+设备的salt值).hex</p>
<blockquote>
<p>2.2 手势密码分析</p>
</blockquote>
<p>大致同上</p>
<h4 id="3-简要">3. 简要：</h4>
<p>​	九宫格团装化成字节数组-&gt;sha1 加密  即可</p>
<p>​	 其实大致流程和分析输入密码差不多   保存到本地的目录、/data/system/gesture.key 文件</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://kuekiko.top/tags/android%E5%AE%89%E5%85%A8">android安全</a></span><span class="tag"><a href="https://kuekiko.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0">读书笔记</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>647 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2018-07-02 17:33 &#43;0800</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://kuekiko.top/posts/2018/07/android%E5%AE%89%E5%85%A8%E5%92%8C%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Android安全和开发环境搭建</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://kuekiko.top/posts/1/01/%E7%8E%AF%E5%A2%83%E8%AE%B0%E5%BD%95%E6%89%8B%E5%8A%A8%E7%BD%AE%E9%A1%B6/">
                                <span class="button__text">环境记录(手动置顶)</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
                <span><a href="https://kuekiko.top">Kuekiko</a></span>
            
            
                <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            
            <span> <a href="https://kuekiko.top/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://kuekiko.top/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
